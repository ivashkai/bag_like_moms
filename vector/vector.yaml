sources:
  rabbitmq_source:
    type: amqp
    connection_string: "amqp://guest:guest@rabbitmq:5672/%2f"
    queue: "events"

transforms:
  parse_data:
    type: remap
    inputs: ["rabbitmq_source"]
    source: |
      . = parse_json!(.message)
      .timestamp = now()

  extract_logs:
    type: remap
    inputs: ["parse_data"]
    source: |
      log_data = .log
      log_data.timestamp = .timestamp
      . = log_data

  make_metrics:
    type: log_to_metric
    inputs: ["parse_data"]
    metrics:
      - type: gauge
        field: metrics.price
        name: shop_item_price
      - type: gauge
        field: metrics.latency
        name: shop_request_latency
      - type: counter
        field: metrics.is_error
        name: shop_errors_total

sinks:
  to_vm_metrics:
    type: prometheus_remote_write
    inputs: ["make_metrics"]
    endpoint: "http://victoriametrics:8428/api/v1/write"

  to_vm_logs:
    type: elasticsearch
    inputs: ["extract_logs"]
    endpoint: "http://victorialogs:9428/insert/elasticsearch/"
    mode: bulk
    api_version: v7